\chapter{Návrh}

V této kapitole se budu věnovat návrhu knihovny na automatizaci a jejím funkčním požadavkům.

\section{Zařízení}
V rámci knihovny a testovacího běhu se bude vyskytovat několik účastníků. Tyto participanti budou:

\begin{description}
    \item[Testovací zařízení] Hlavní zařízení, ze kterého poběží testovací služba.
    \item[Fyzický participant] Fyzické zařízení, které běží mimo zařízení s testovací službou. 
    \item[Virtuální participant] Zařízení, které simuluje protistranu fyzickým participantům. Toto zařízení běží na stejném zařízení jako testovací služba.
\end{description}

Hlavním cílem je testovat vyvíjený produkt. V kontextu této knihovny ho budeme nazývat fyzický participant. Do této kategorie avšak také bude patřit jakékoliv zařízení, které běží mimo zařízení, které řídí testování. Tato zařízení budou k zařízení, které řídí testovaní, připojena za pomoci Ethernet připojení.

Knihovna zároveň bude obsahovat tzv. virtuálního participanta. Toto zařízení bude sloužit k simulaci protistrany u testování fyzického zařízení. Je to volitelný participant. Zároveň může být během testu připojeno více virtuálních participantů. Simulováním participanta snižujeme hardwarové nároky na testování, což vede ke snížení ekonomických nákladů na testování. Tito participanti se budou připojovat před započnutím určitého testu a po skončení tohoto jednoho testu zaniknou.

Testovací služba poběží na samostatném zařízení. Toto zařízení bude běžet na operačním systému Windows. Toto zařízení bude v rámci infrastruktury serveru Azure DevOps tzv. agent. Agent je výpočetní infrastruktura s nainstalovaným softwarem agenta, který pracuje na jedné určité úloze \cite{agent_docs}. Na agentovi bude server Azure DevOps spouštět testovací běh.

Testovací knihovna a virtuální participant budou vyvinuti v jazyce \inlinecode{C\#}. Jazyk byl vybrán kvůli dobrému rozsahu již implementovaných komponent a kvůli dobré interoperabilitě se serverem Azure DevOps, díky tomu že obě části jsou vyvíjeny společností Microsoft. Rozhraní pro vyvíjený produkt bude vytvořeno v jazyce \inlinecode{C++}, jelikož tento produkt je v tomto jazyce vyvíjen.

\begin{figure}[htbp]
    \centering 
    \includegraphics[width=0.95\textwidth]{assets/img/deploymentmodel.pdf}
    \caption{Deployment model}
    \label{fig:deploymodel}
\end{figure}


\section{Komunikace}
Komunikace mezi participanty bude fungovat na principu TCP/IP připojení. Zároveň zprávy, které budou mezi službou a participanty vyměňovány, budou mít stanovenou strukturu. Jedna zpráva bude obsahovat délku zprávy, typ zprávy a poté data zprávy. Data zprávy se budou odvíjet od typu zprávy. Existují i situace, kdy zpráva žádná data obsahovat nebude, k přenesení informace tedy bude stačit pouze typ zprávy. 

Složení zprávy lze vidět na obrázku \ref{fig:message}. Všechny hodnoty budou ukládány v kladné (anglicky tzv. unsigned) podobě. Z diagramu lze vidět, že jedna zpráva bude mít maximální délku rovna číslu, které se vejde do dvou bajtů, tedy maximální délka jedné zprávy je 65~535 bajtů. Tato délka je ale více než dostatečná pro navrhované použití. Testovací knihovna bude primárně definovat a přijímat tyto typy zpráv:

\begin{itemize}
    \item Zpráva o úspěchu
    \item Zpráva o neúspěchu
    \item Direktiva ke spuštění testu
    \item Direktiva k ukončení testování
\end{itemize}

\begin{figure}[htbp]
    \centering 
    \includegraphics{assets/img/message.pdf}
    \caption{Diagram struktury jedné zprávy}
    \label{fig:message}
\end{figure}



\section{Rozhraní pro testování}
Součástí knihovny taktéž bude rozhraní, pro implementaci zařízení, které bude testováno. Toto rozhraní bude mít jasně definovanou  strukturu, ale zároveň bude co nejjednodušší pro co nejrychlejší implementaci na nově testovaném zařízení. Toto rozhraní bude potom využito pro řízení běhu testu na testovaném zařízení. 

Další součástí bude i rozhraní pro jednotlivé testy. To bude obsahovat jednotlivá stádia testování, která budou mezi všemi zařízeními synchronizovány. Tyto stádia budou, v tom pořadí:
\begin{enumerate}
    \item Příprava na testování -- definování potřebných struktur, inicializace
    \item Testování -- provedení samotného testu
    \item Úklid po testu -- uvolnění využitých zdrojů
\end{enumerate}

\section{Testovací služba}
Ve vyvíjené knihovně bude jádrem k řízení testování služba, která se bude starat o běh testování. Interakci služby s účastníky testovaní můžeme vidět v sekvenčním diagramu, který je na obrázku \ref{fig:seqdiag}. Obsah tohoto diagramu bude rozebrán v následujících částech.

\begin{figure}[htbp]
    \centering 
    \includegraphics[width=0.95\textwidth]{assets/img/sequencediagram.pdf}
    \caption{Sekvenční diagram znázorňující běh služby}
    \label{fig:seqdiag}
\end{figure}

\subsection{Inicializace služby}
\todo{Doplnit}



\section{Proces testování}

Ze předchozí definice testování vyplývá, že knihovna je mířena na automatizaci funkčního testování. Každý testovací běh se bude moct skládat z libovolného počtu registrovaných testů. Na obrázku \ref{fig:act_diag_device} můžeme vidět diagram aktivit testovaného zařízení. Tento diagram ukazuje běh testovaného zařízení. Jeho běh se odvíjí na základě instrukcí, které obdrží od testovací služby. Zařízení nejdříve projde inicializační fázi, ve které se připojí k testovací službě. 


Samotné kontrolování správnosti testu bude prací jednotlivých testerů. Knihovna pouze dostane informaci o úspěchu nebo neúspěchu jednotlivých synchronizačních částí testovaní, definovaných rozhraním pro testování. Pokud ve fázi přípravy na testování nebo úklidu po testu zařízení vrátí neúspěch, bude toto zařízení považováno jako v chybném stavu. Další testy poté nebudou provedeny. 

\begin{figure}
    \centering 
    \includegraphics[width=\textwidth]{assets/img/activitydiagramdevice.pdf}
    \caption{Diagram aktivit testované zařízení}
    \label{fig:act_diag_device}
\end{figure}

\section{Propojení se serverem Azure DevOps}
Jedním z cílů této práce je vytvoření takového připojení, aby server Azure DevOps byl schopen spouštět jednotlivé testy. K tomuto propojení využijeme testovací framework MSTest. Vyvíjená testovací knihovna tedy poběží nad tímto testovacím frameworkem. Za pomoci frameworku MSTest bude server Azure DevOps schopen registrovat jednotlivé testy, a spouštět je jednotlivě.

